*--------------------------------------------------------------------------------------------------------------------------------------------------------
* (ES) AUTOGENERADO - ¡¡ATENCIÓN!! - ¡¡NO PENSADO PARA EJECUTAR!! USAR SOLAMENTE PARA INTEGRAR CAMBIOS Y ALMACENAR CON HERRAMIENTAS SCM!!
* (EN) AUTOGENERATED - ATTENTION!! - NOT INTENDED FOR EXECUTION!! USE ONLY FOR MERGING CHANGES AND STORING WITH SCM TOOLS!!
*--------------------------------------------------------------------------------------------------------------------------------------------------------
*< FOXBIN2PRG: Version="1.19" SourceFile="de_saldos.scx" /> (Solo para binarios VFP 9 / Only for VFP 9 binaries)
*
*
#INCLUDE "..\include\sisfotos.h"

DEFINE CLASS dataenvironment AS dataenvironment 
 	*< CLASSDATA: Baseclass="dataenvironment" Timestamp="" Scale="" Uniqueid="" ClassIcon="1" />

	DataSource = .NULL.
	Height = 200
	Left = 1
	Name = "Dataenvironment"
	Top = 220
	Width = 520

ENDDEFINE

DEFINE CLASS forsaldosfacturas AS form 
 	*< CLASSDATA: Baseclass="form" Timestamp="" Scale="" Uniqueid="" />

	*-- OBJECTDATA items order determines ZOrder / El orden de los items OBJECTDATA determina el ZOrder 
	*< OBJECTDATA: ObjPath="grimodelos" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column1.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column1.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column2.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column2.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column3.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column3.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column4.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column4.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column5.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column5.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column6.Header1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="grimodelos.Column6.Text1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cmdcerraro" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Label1" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="txttotal" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="txtpagos" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Cmdaceptar" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Txtlocalizador" UniqueID="" Timestamp="" />
	*< OBJECTDATA: ObjPath="Label2" UniqueID="" Timestamp="" />

	*<DefinedPropArrayMethod>
		*p: ndoc
		*p: tpagos
	*</DefinedPropArrayMethod>

	AutoCenter = .T.
	BorderStyle = 1
	Caption = "[Documentos Pendientes de Pago]"
	ControlBox = .F.
	DoCreate = .T.
	FontName = "Tahoma"
	Height = 302
	MaxButton = .F.
	MinButton = .F.
	Movable = .T.
	Name = "forsaldosfacturas"
	Width = 545
	WindowType = 1

	ADD OBJECT 'Cmdaceptar' AS cmdaceptar WITH ;
		FontName = "Tahoma", ;
		Height = 33, ;
		Left = 6, ;
		Name = "Cmdaceptar", ;
		PicturePosition = 1, ;
		TabIndex = 3, ;
		Top = 268, ;
		Width = 110
		*< END OBJECT: ClassLib="..\libs\sisfotos.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'Cmdcerraro' AS cmdcerraro WITH ;
		FontName = "Tahoma", ;
		Height = 35, ;
		Left = 429, ;
		Name = "Cmdcerraro", ;
		PicturePosition = 1, ;
		TabIndex = 4, ;
		Top = 266, ;
		Width = 110
		*< END OBJECT: ClassLib="..\libs\sisfotos.vcx" BaseClass="commandbutton" />

	ADD OBJECT 'grimodelos' AS grid WITH ;
		BackColor = 174,202,210, ;
		ColumnCount = 6, ;
		DeleteMark = .F., ;
		FontName = "Tahoma", ;
		GridLines = 3, ;
		HeaderHeight = 28, ;
		Height = 228, ;
		Left = 5, ;
		Name = "grimodelos", ;
		Panel = 1, ;
		ReadOnly = .T., ;
		ScrollBars = 2, ;
		TabIndex = 2, ;
		Top = 38, ;
		Width = 540, ;
		Column1.BackColor = 174,202,210, ;
		Column1.ColumnOrder = 2, ;
		Column1.FontName = "Tahoma", ;
		Column1.Name = "Column1", ;
		Column1.ReadOnly = .T., ;
		Column1.Width = 99, ;
		Column2.BackColor = 174,202,210, ;
		Column2.ColumnOrder = 3, ;
		Column2.FontName = "Tahoma", ;
		Column2.Name = "Column2", ;
		Column2.ReadOnly = .T., ;
		Column2.Width = 100, ;
		Column3.BackColor = 174,202,210, ;
		Column3.ColumnOrder = 4, ;
		Column3.FontName = "Tahoma", ;
		Column3.Name = "Column3", ;
		Column3.ReadOnly = .F., ;
		Column3.Width = 99, ;
		Column4.BackColor = 174,202,210, ;
		Column4.ColumnOrder = 5, ;
		Column4.FontName = "Tahoma", ;
		Column4.Name = "Column4", ;
		Column4.ReadOnly = .T., ;
		Column4.Width = 73, ;
		Column5.BackColor = 174,202,210, ;
		Column5.ColumnOrder = 1, ;
		Column5.FontName = "Tahoma", ;
		Column5.Name = "Column5", ;
		Column5.ReadOnly = .T., ;
		Column5.Width = 59, ;
		Column6.BackColor = 174,202,210, ;
		Column6.FontName = "Tahoma", ;
		Column6.Name = "Column6", ;
		Column6.ReadOnly = .T., ;
		Column6.Width = 70
		*< END OBJECT: BaseClass="grid" />

	ADD OBJECT 'grimodelos.Column1.Header1' AS header WITH ;
		Caption = "Nº Documento", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grimodelos.Column1.Text1' AS textbox WITH ;
		BackColor = 174,202,210, ;
		BorderStyle = 0, ;
		FontName = "Tahoma", ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grimodelos.Column2.Header1' AS header WITH ;
		Caption = "Importe", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grimodelos.Column2.Text1' AS textbox WITH ;
		BackColor = 174,202,210, ;
		BorderStyle = 0, ;
		FontName = "Tahoma", ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grimodelos.Column3.Header1' AS header WITH ;
		Caption = "Pagos", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grimodelos.Column3.Text1' AS textbox WITH ;
		BackColor = 174,202,210, ;
		BorderStyle = 0, ;
		FontName = "Tahoma", ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .F.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grimodelos.Column4.Header1' AS header WITH ;
		Caption = "Fecha", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grimodelos.Column4.Text1' AS textbox WITH ;
		BackColor = 174,202,210, ;
		BorderStyle = 0, ;
		FontName = "Tahoma", ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grimodelos.Column5.Header1' AS header WITH ;
		Caption = "Tipo Doc.", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grimodelos.Column5.Text1' AS textbox WITH ;
		BackColor = 174,202,210, ;
		BorderStyle = 0, ;
		FontName = "Tahoma", ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'grimodelos.Column6.Header1' AS header WITH ;
		Caption = "Dias Vto", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Name = "Header1"
		*< END OBJECT: BaseClass="header" />

	ADD OBJECT 'grimodelos.Column6.Text1' AS textbox WITH ;
		BackColor = 174,202,210, ;
		BorderStyle = 0, ;
		ForeColor = 0,0,0, ;
		Margin = 0, ;
		Name = "Text1", ;
		ReadOnly = .T.
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'Label1' AS label WITH ;
		Caption = "Totales:", ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Height = 16, ;
		Left = 117, ;
		Name = "Label1", ;
		TabIndex = 5, ;
		Top = 279, ;
		Width = 53
		*< END OBJECT: BaseClass="label" />

	ADD OBJECT 'Label2' AS label WITH ;
		Caption = "Buscar:", ;
		FontName = "Tahoma", ;
		FontUnderline = .T., ;
		Height = 16, ;
		Left = 15, ;
		Name = "Label2", ;
		TabIndex = 8, ;
		Top = 12, ;
		Width = 43
		*< END OBJECT: BaseClass="label" />

	ADD OBJECT 'Txtlocalizador' AS txtlocalizador WITH ;
		buscado = ndoc, ;
		campos = tdoc,ndoc,importe,acta,fecha,dias, ;
		corden = fecha, ;
		ctabla = tcreditos, ;
		Height = 22, ;
		Left = 63, ;
		Name = "Txtlocalizador", ;
		TabIndex = 1, ;
		tipo = C, ;
		Top = 9, ;
		Width = 218
		*< END OBJECT: ClassLib="..\libs\sisven.vcx" BaseClass="textbox" />

	ADD OBJECT 'txtpagos' AS textbox WITH ;
		Alignment = 3, ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Format = "999,999.99", ;
		Height = 23, ;
		InputMask = "999,999.99", ;
		Left = 275, ;
		Name = "txtpagos", ;
		ReadOnly = .T., ;
		SpecialEffect = 1, ;
		TabIndex = 7, ;
		Top = 275, ;
		Value = 0, ;
		Width = 101
		*< END OBJECT: BaseClass="textbox" />

	ADD OBJECT 'txttotal' AS textbox WITH ;
		Alignment = 3, ;
		FontBold = .T., ;
		FontName = "Tahoma", ;
		Format = "999,999.99", ;
		Height = 23, ;
		InputMask = "999,999.99", ;
		Left = 172, ;
		Name = "txttotal", ;
		ReadOnly = .T., ;
		SpecialEffect = 1, ;
		TabIndex = 6, ;
		Top = 275, ;
		Value = 0, ;
		Width = 101
		*< END OBJECT: BaseClass="textbox" />
	
	PROCEDURE Init
		lparameters ccodc,dfecha
		store 0 to xcant
		WITH thisform
		.grimodelos.recordsource=""
		.txttotal.value=0
		create cursor pdtes(tdoc c(2),ndoc C(10),importe N(10,2),acta n(10,2),fecha D,dias n(10))
		***************
		select dcto,tdoc,fech,fevto,esta,impo,acta,docp from fe_cred where fech<=dfecha and codc=ccodc;
		into cursor creditosf order by esta
		sele creditosf
		SCAN ALL 
		      if creditosf.acta>0 and !empty(creditosf.docp)
		          SELECT pdtes
		          LOCATE FOR alltrim(ndoc)=alltrim(creditosf.docp) and importe>0
		          repla importe with importe-creditosf.acta,fecha with creditosf.fech,dias with dfecha-creditosf.fevto
		        ELSE 
		         SELECT pdtes
		         LOCATE FOR ALLTRIM(ndoc)=ALLTRIM(creditosf.dcto) AND tdoc=creditosf.tdoc
		         IF !FOUND()
		            INSERT INTO pdtes(tdoc,ndoc,importe,fecha,dias)values(creditosf.tdoc,creditosf.dcto,;
		            creditosf.impo,creditosf.fech,dfecha-creditosf.fevto)
		           ELSE
		             REPLACE importe WITH importe+creditosf.impo,fecha WITH creditosf.fech,;
		             dias WITH dfecha-creditosf.fevto,ndoc WITH creditosf.dcto IN pdtes
		         ENDIF     
		      ENDIF 
		ENDSCAN 
		**************
		SELECT dcto,tdoc,fech,fevto,esta,impo,acta,docp from fe_cred where fech<=dfecha and codc=ccodc and empty(fe_cred.docp);
		into cursor creditossf order by esta
		SELECT creditossf
		SCAN ALL 
		       if esta<>"C"
		          xcant=0
		          xdescargue=0
		          sele pdtes
		          go top
		          do while !eof()
		             if pdtes.importe=0
		                y=0
		                skip
		                loop
		             endif 
		             if xcant>=creditossf.acta
		                exit
		             endif  
		             if (creditossf.acta-xcant)<pdtes.importe
		                xdescargue=creditossf.acta-xcant
		                xcant=creditossf.acta
		                repla importe with importe-xdescargue
		                exit   
		              else
		               if pdtes.importe>0
		                  xcant=xcant+pdtes.importe
		                  xdescargue=pdtes.importe
		                  repla importe with importe-xdescargue
		                 else
		                  xdescargue=creditossf.impo-xcant                    
		                  repla importe with importe-xdescargue
		                 endif
		              endif
		              skip
		          endd   
		          if (xcant-creditossf.impo)<0
		             xdescargue=creditossf.impo-xcant
		          endif   
		   endif 
		endscan
		***************
		SELECT tdoc,ndoc,importe,acta,fecha,dias FROM pdtes WHERE importe<>0 INTO CURSOR tcreditos 
		SELECT sum(importe) as timporte FROM pdtes INTO CURSOR r
		thisform.txttotal.value=r.timporte
		SELECT pdtes
		SET FILTER TO importe<>0
		GO TOP IN pdtes 
		thisform.grimodelos.recordsource="pdtes"
		thisform.grimodelos.refresh
		ENDWITH 
		****************
	ENDPROC

	PROCEDURE Unload
		RETURN thisform.tpagos 
	ENDPROC

	PROCEDURE Cmdaceptar.Click
		thisform.tpagos=thisform.txtpagos.Value
		thisform.grimodelos.RecordSource=""
		thisform.Release 
	ENDPROC

	PROCEDURE Cmdcerraro.Click
		*thisform.ndoc=""
		thisform.tpagos=0
		dodefault()
	ENDPROC

	PROCEDURE grimodelos.Column1.Text1.KeyPress
		LPARAMETERS nKeyCode, nShiftAltCtrl
		
	ENDPROC

	PROCEDURE grimodelos.Column3.Text1.LostFocus
		LOCAL r
		IF this.value>pdtes.importe 
		   MESSAGEBOX("El Importe A Cancelar No Puede Ser Mayor Al Monto de la Factura",48,MSGTITULO)
		   this.Value=0
		   RETURN 
		ENDIF    
		SELECT pdtes
		r=RECNO()
		SUM acta TO thisform.txtpagos.Value 
		IF r<>0
		   GO r
		ENDIF 
	ENDPROC

	PROCEDURE Txtlocalizador.InteractiveChange
		this.mostrar()
	ENDPROC

	PROCEDURE Txtlocalizador.LostFocus
		thisform.grimodelos.column3.text1.SetFocus 
	ENDPROC

ENDDEFINE
